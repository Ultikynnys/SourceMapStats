<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Map Stats Visualization</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- =========================================================
         GitHub CORNER (fixed notch, top‑right)
         ========================================================= -->
    <a href="https://github.com/Ultikynnys/SourceMapStats"
       class="github-corner"
       aria-label="View SourceMapStats on GitHub"
       target="_blank" rel="noopener">
        <svg width="100" height="100" viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"
                  fill="#f39c12"></path>
            <path class="octo-arm"
                  d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6
                     C122.0,82.7 120.5,78.6 120.5,78.6
                     C119.2,72.0 123.4,76.3 123.4,76.3
                     C127.3,80.9 125.5,87.3 125.5,87.3
                     C122.9,97.6 130.6,101.9 134.4,103.2"
                  fill="currentColor"
                  style="transform-origin: 130px 106px;"></path>
            <path class="octo-body"
                  d="M115.0,115.0
                     C114.9,115.1 118.7,116.5 119.8,115.4
                     L133.7,101.6
                     C136.9,99.2 139.9,98.4 142.2,98.6
                     C133.8,88.0 127.5,74.4 143.8,58.0
                     C148.5,53.4 154.0,51.2 159.7,51.0
                     C160.3,49.4 163.2,43.6 171.4,40.1
                     C171.4,40.1 176.1,42.5 178.8,56.2
                     C183.1,58.6 187.2,61.8 190.9,65.4
                     C194.5,69.0 197.7,73.2 200.1,77.6
                     C213.8,80.2 216.3,84.9 216.3,84.9
                     C212.7,93.1 206.9,96.0 205.4,96.6
                     C205.1,102.4 203.0,107.8 198.3,112.5
                     C181.9,128.9 168.3,122.5 157.7,114.1
                     C157.9,116.9 156.7,120.9 152.7,124.9
                     L141.0,136.5
                     C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                  fill="currentColor"></path>
        </svg>
    </a>

    <!-- =========================================================
         MAIN APP
         ========================================================= -->
    <div class="container">
        <header>
            <h1>Map Stats Visualization</h1>
        </header>

        <div class="chart-params-container">
            <!-- LEFT: chart + status -->
            <div class="left-column">
                <section class="chart-box">
                    <canvas id="chartCanvas" width="800" height="400"></canvas>
                    <p id="playerCountDisplay"></p>
                    <button id="refreshChart" class="btn">Refresh Chart</button>
                </section>

                <section class="status-section">
                    <h2>Status</h2>
                    <div class="btn-group">
                        <button id="startScan" class="btn">Start Scanning</button>
                        <button id="stopScan"  class="btn">Stop Scanning</button>
                    </div>
                    <p id="scanningStatus">Scanning Status: Idle</p>
                    <p id="scanningMode">Scanning Mode: None</p>
                    <p id="currentIP">Current IP: None</p>
                    <p id="lastError">Last Error: None</p>
                    <p id="apiKeyState">API Key State: Unknown</p>

                    <!-- connection indicator (populated by JS) -->
                    <p id="connectionStatus" class="disconnected">No server found</p>

                    <button id="refreshStatus" class="btn">Refresh Status</button>
                </section>
            </div>

            <!-- RIGHT: parameters -->
            <section class="params-section">
                <h2>Parameters</h2>
                <form id="paramsForm">
                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="text" id="apiKey" name="apiKey" value="">
                    </div>

                    <!-- Maps‑to‑show dropdown 1‑10 -->
                    <div class="form-group">
                        <label for="MapsToShow">Maps To Show:</label>
                        <select id="MapsToShow" name="MapsToShow">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10" selected>10</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="Start_Date">Start Date:</label>
                        <input type="date" id="Start_Date" name="Start_Date" value="2001-10-02">
                    </div>

                    <div class="form-group">
                        <label for="End_Date">End Date:</label>
                        <input type="date" id="End_Date" name="End_Date" value="2040-10-02">
                    </div>

                    <div class="form-group">
                        <label for="OnlyMapsContaining">Only Maps Containing:</label>
                        <input type="text" id="OnlyMapsContaining" name="OnlyMapsContaining" value="dr_">
                    </div>

                    <!-- Average‑days dropdown -->
                    <div class="form-group">
                        <label for="AverageDays">Days Per Point:</label>
                        <select id="AverageDays" name="AverageDays">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="7">7</option>
                            <option value="30">30</option>
                        </select>
                    </div>

                    <!-- Hidden when key invalid -->
                    <div class="form-group" id="fastWriteGroup" style="display:none;">
                        <label for="FastWriteDelay">Fast Write Delay&nbsp;(min):</label>
                        <input type="number" id="FastWriteDelay" name="FastWriteDelay" value="10">
                    </div>
                    <div class="form-group" id="runtimeMinutesGroup" style="display:none;">
                        <label for="RuntimeMinutes">Runtime Minutes:</label>
                        <input type="number" id="RuntimeMinutes" name="RuntimeMinutes" value="60">
                    </div>

                    <div class="form-group">
                        <label for="ColorIntensity">Color Intensity:</label>
                        <input type="number" id="ColorIntensity" name="ColorIntensity" value="3">
                    </div>

                    <!-- Game dropdown -->
                    <div class="form-group">
                        <label for="Game">Game:</label>
                        <select id="Game" name="Game">
                            <option value="tf" selected>Team Fortress 2 (tf)</option>
                            <option value="csgo">Counter‑Strike: Global Offensive (csgo)</option>
                            <option value="cstrike">Counter‑Strike: Source (cstrike)</option>
                            <option value="dod">Day of Defeat: Source (dod)</option>
                            <option value="hl2mp">Half‑Life 2: Deathmatch (hl2mp)</option>
                            <option value="left4dead2">Left 4 Dead 2 (left4dead2)</option>
                            <option value="left4dead">Left 4 Dead (left4dead)</option>
                            <option value="garrysmod">Garry’s Mod (garrysmod)</option>
                            <option value="insurgency">Insurgency (insurgency)</option>
                            <option value="synergy">Synergy (synergy)</option>
                            <option value="alienswarm">Alien Swarm (alienswarm)</option>
                        </select>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <footer>
        <div class="footer-content">
            <p class="description">
                <strong>SourceMapStats</strong> is a map‑statistics tool that queries the Source Master Server,
                gathers player frequency per map, and renders that data as an interactive chart.
            </p>
            <p class="copyright">&copy; Ultikynnys 2025</p>
        </div>
    </footer>

    <!-- ================= JS ================= -->
    <script>
        /*  -----------------  HELPER  ----------------- */
        function createThrottledFunction(fn, delay) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }
        function setAllButtonsDisabled(disabled) {
            document.querySelectorAll("button").forEach(btn => btn.disabled = disabled);
        }

        /* --------------  SANITISERS & RULES  -------------- */
        function sanitizeApiKey(key)  { return key.replace(/[^a-zA-Z0-9-_]/g, ''); }
        function hasValidApiKey(key)  { return key && key.length >= 10; }      /* STRICT for scanning */

        /* --------------  FETCH WRAPPER  -------------- */
        async function doFetch(url, options = {}) {
            options.headers = options.headers || {};
            const rawKey = document.getElementById('apiKey')?.value || '';
            const key    = sanitizeApiKey(rawKey);

            /* attach only if ≥ 10 chars (chart requests *never* require it) */
            if (hasValidApiKey(key)) options.headers['X-API-KEY'] = key;

            const response = await fetch(url, options);

            /* Rate‑limit handling */
            if (response.status === 429) {
                const data     = await response.json().catch(() => ({}));
                const cooldown = 1;        /* seconds */
                alert(`Rate Limited: ${data.error || 'Too many requests'}. Cool‑down: ${cooldown}s`);
                setAllButtonsDisabled(true);
                setTimeout(() => setAllButtonsDisabled(false), cooldown * 1000);
                throw new Error('Rate Limit');
            }

            /* Unauthorized → mark key invalid immediately */
            if (response.status === 401) {
                document.getElementById('apiKeyState').textContent = 'API Key State: Invalid';
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const msg  = data.error || `HTTP Error ${response.status}`;
                alert(msg);
                throw new Error(msg);
            }
            return response.json();
        }

        /* --------------  SERVER‑SIDE KEY VALIDATION  -------------- */
        async function validateApiKey(key) {
            if (!hasValidApiKey(key)) return false;
            try {
                const res = await fetch('/api/validate_key', {
                    cache  : 'no-store',
                    headers: { 'X-API-KEY': key }
                });
                return res.ok;          // 200 ⇒ true, 401/other ⇒ false
            } catch (_) {
                return false;           // network failure ⇒ invalid for now
            }
        }

        /*  -----------------  CONNECTION STATUS  ----------------- */
        async function updateConnectionStatus () {
            const el = document.getElementById('connectionStatus');
            try {
                const res = await fetch('/api/heartbeat', { cache: 'no-store' });
                if (res.ok) {
                    el.textContent = 'Connected';
                    el.classList.remove('disconnected');
                    el.classList.add('connected');
                } else {
                    throw new Error('Heartbeat failed');
                }
            } catch (_) {
                el.textContent = 'No server found';
                el.classList.remove('connected');
                el.classList.add('disconnected');
            }
        }
        /* ping immediately, then every 5 s */
        setInterval(updateConnectionStatus, 5_000);

        /*  -----------------  STATUS / KEY HANDLING  ----------------- */
        let statusInterval = null;

        function toggleExtraParams(show) {
            const fastWrite   = document.getElementById('fastWriteGroup');
            const runtimeMins = document.getElementById('runtimeMinutesGroup');
            if (fastWrite && runtimeMins) {
                fastWrite.style.display   = show ? 'flex' : 'none';
                runtimeMins.style.display = show ? 'flex' : 'none';
            }
        }

        async function checkApiKeyState() {
            const apiKeyElem = document.getElementById('apiKey');

            /* sanitise visible input */
            const rawInput = apiKeyElem.value;
            const key      = sanitizeApiKey(rawInput);
            if (rawInput !== key) apiKeyElem.value = key;

            /* ---------  No ≥10‑char key entered → chart‑only mode  --------- */
            if (!hasValidApiKey(key)) {
                document.getElementById('apiKeyState').textContent =
                    'API Key State: Not supplied — chart‑only mode';

                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display  = 'none';
                toggleExtraParams(false);

                if (statusInterval) { clearInterval(statusInterval); statusInterval = null; }
                return;
            }

            /* ---------  Length OK, ask server  --------- */
            const serverOK = await validateApiKey(key);
            if (!serverOK) {
                document.getElementById('apiKeyState').textContent = 'API Key State: Invalid';
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display  = 'none';
                toggleExtraParams(false);
                if (statusInterval) { clearInterval(statusInterval); statusInterval = null; }
                return;
            }

            /* ---------  Fully valid key  --------- */
            document.getElementById('apiKeyState').textContent = 'API Key State: Valid';
            document.getElementById('startScan').style.display = 'inline-block';
            document.getElementById('stopScan').style.display  = 'inline-block';
            toggleExtraParams(true);

            if (!statusInterval) {
                statusInterval = setInterval(() => refreshStatus().catch(console.error), 1_000);
            }
        }

        async function checkCSVStatus() {
            try {
                const data = await doFetch('/api/csv_status');
                document.getElementById('refreshChart').disabled = !(data.exists && !data.empty);
            } catch (e) { console.error(e); }
        }

        /*  -----------------  CHART  ----------------- */
        const totalPlayerPlugin = {
            id: 'totalPlayerPlugin',
            afterDraw: chart => {
                const { ctx, chartArea:{ top, right } } = chart;
                ctx.save();
                ctx.fillStyle   = 'white';
                ctx.font        = '16px Arial';
                ctx.textAlign   = 'right';
                ctx.fillText(`Total Players: ${chart.config.data.totalPlayers || 0}`, right - 10, top + 20);
                ctx.restore();
            }
        };
        async function fetchData() { return doFetch('/api/data'); }

        function renderChart(data) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            const chartData = { labels: data.labels, datasets: data.datasets, totalPlayers: data.totalPlayers };

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: false,
                    plugins: {
                        title:   { display: true, text: `Top ${data.shownMapsCount} Maps out of ${data.totalFilteredMaps}`, color: 'white' },
                        legend:  { labels: { color: 'white' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.2)' } },
                        y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.2)' } }
                    }
                },
                plugins: [ totalPlayerPlugin ]
            });
            document.getElementById('playerCountDisplay').textContent =
                `Average Daily Player Count: ${data.averageDailyPlayerCount}`;
        }

        const updateChart = createThrottledFunction(async () => {
            /* Push current form values to API */
            const formData = new FormData(document.getElementById('paramsForm'));
            const params   = {};
            formData.forEach((value, key) => { if (key !== 'apiKey') params[key] = value; });

            await doFetch('/api/update_params', {
                method:  'POST',
                headers: { 'Content-Type': 'application/json' },
                body:    JSON.stringify(params)
            });

            await checkCSVStatus();
            const data = await fetchData();
            if (!data.labels?.length) { alert('No chart data found (CSV empty or out of range).'); return; }
            renderChart(data);
        }, 1_000);

        /*  -----------------  SCAN / STATUS BUTTONS  ----------------- */
        async function startScanning() {
            const key = sanitizeApiKey(document.getElementById('apiKey').value);
            if (!hasValidApiKey(key)) { alert('API key must be at least 10 characters.'); return; }
            try {
                const res = await doFetch('/api/start_scan', { method:'POST' });
                alert(res.status || res.error);
            } catch (e) { console.error(e); }
        }
        async function stopScanning() {
            const key = sanitizeApiKey(document.getElementById('apiKey').value);
            if (!hasValidApiKey(key)) { alert('API key must be at least 10 characters.'); return; }
            try {
                const res = await doFetch('/api/stop_scan', { method:'POST' });
                alert(res.status || res.error);
            } catch (e) { console.error(e); }
        }
        async function fetchStatus()    { return doFetch('/api/status'); }
        async function refreshStatus() {
            const s = await fetchStatus();
            document.getElementById('scanningStatus').textContent = `Scanning Status: ${s.scanning_status}`;
            document.getElementById('scanningMode').textContent   = `Scanning Mode: ${s.scanning_mode}`;
            document.getElementById('currentIP').textContent      = `Current IP: ${s.current_scanned_ip || 'None'}`;
            document.getElementById('lastError').textContent      = `Last Error: ${s.last_error || 'None'}`;
            /* keep the visible API‑key status accurate */
            checkApiKeyState();
        }

        /*  -----------------  INIT  ----------------- */
        document.addEventListener('DOMContentLoaded', async () => {
            updateConnectionStatus();   /* first ping   */
            await checkApiKeyState();
            await checkCSVStatus();
            await refreshStatus();
            updateChart();
        });
        document.getElementById('refreshChart').addEventListener('click', updateChart);
        document.getElementById('startScan').addEventListener('click',   startScanning);
        document.getElementById('stopScan').addEventListener('click',    stopScanning);
        document.getElementById('refreshStatus').addEventListener('click', refreshStatus);
        /* re‑validate on every keystroke */
        document.getElementById('apiKey').addEventListener('input',
            () => checkApiKeyState().catch(console.error));
    </script>
</body>
</html>
