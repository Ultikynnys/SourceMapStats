<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Map Stats Visualization</title>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Map Stats Visualization</h1>
        </header>
        
        <section class="chart-section">
            <canvas id="chartCanvas" width="800" height="400"></canvas>
            <p id="playerCountDisplay"></p>
            <button id="refreshChart" class="btn">Refresh Chart</button>
        </section>
        
        <section class="controls-section">
            <div class="btn-group">
                <button id="startScan" class="btn">Start Scanning</button>
                <button id="stopScan" class="btn">Stop Scanning</button>
            </div>
        </section>
        
        <section class="status-section">
            <h2>Status</h2>
            <p id="scanningStatus">Scanning Status: Idle</p>
            <p id="scanningMode">Scanning Mode: None</p>
            <p id="currentIP">Current IP: None</p>
            <p id="lastError">Last Error: None</p>
            <p id="apiKeyState">API Key State: Unknown</p>
            <button id="refreshStatus" class="btn">Refresh Status</button>
        </section>
        
        <section class="params-section">
            <h2>Update Parameters</h2>
            <form id="paramsForm">
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey" name="apiKey" value="">
                </div>

                <div class="form-group">
                    <label for="MapsToShow">Maps To Show:</label>
                    <input type="number" id="MapsToShow" name="MapsToShow" value="15">
                </div>
                
                <div class="form-group">
                    <label for="Start_Date">Start Date:</label>
                    <input type="date" id="Start_Date" name="Start_Date" value="2001-10-02">
                </div>
                
                <div class="form-group">
                    <label for="End_Date">End Date:</label>
                    <input type="date" id="End_Date" name="End_Date" value="2040-10-02">
                </div>
                
                <div class="form-group">
                    <label for="OnlyMapsContaining">Only Maps Containing:</label>
                    <input type="text" id="OnlyMapsContaining" name="OnlyMapsContaining" value="dr_">
                </div>
                
                <div class="form-group">
                    <label for="AverageDays">Average Days:</label>
                    <input type="number" id="AverageDays" name="AverageDays" value="1">
                </div>
                
                <div class="form-group">
                    <label for="FastWriteDelay">Fast Write Delay (min):</label>
                    <input type="number" id="FastWriteDelay" name="FastWriteDelay" value="10">
                </div>
                
                <div class="form-group">
                    <label for="RuntimeMinutes">Runtime Minutes:</label>
                    <input type="number" id="RuntimeMinutes" name="RuntimeMinutes" value="60">
                </div>
                
                <div class="form-group">
                    <label for="ColorIntensity">Color Intensity:</label>
                    <input type="number" id="ColorIntensity" name="ColorIntensity" value="3">
                </div>

                <!-- Field to switch game (example: tf, csgo, etc.) -->
                <div class="form-group">
                    <label for="Game">Game:</label>
                    <input type="text" id="Game" name="Game" value="tf">
                </div>
                
                <button type="submit" class="btn">Update Parameters</button>
            </form>
        </section>
    </div>
    
    <script>
        // Throttling helper
        function createThrottledFunction(fn, delay) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }

        // Disable or enable all buttons in the page
        function setAllButtonsDisabled(disabled) {
            const allButtons = document.querySelectorAll("button");
            allButtons.forEach(btn => {
                btn.disabled = disabled;
            });
        }

        // ### KEY CHANGE ###
        // This universal fetch wrapper will attach X-API-KEY if the user has entered a valid one.
        async function doFetch(url, options = {}) {
            // Make sure we have a headers object
            options.headers = options.headers || {};

            // Grab the current API key from the form
            const rawKey = document.getElementById('apiKey')?.value || '';
            const sanitizedKey = rawKey.replace(/[^a-zA-Z0-9-_]/g, '');

            // If it's at least 10 chars, treat it as valid and attach it
            if (sanitizedKey.length >= 10) {
                options.headers['X-API-KEY'] = sanitizedKey;
            }

            const response = await fetch(url, options);
            
            if (response.status === 429) {
                const data = await response.json();
                const cooldown = data.cooldown || 30;
                alert(`Rate Limited: ${data.error}. Cooldown: ${cooldown.toFixed(1)}s`);
                setAllButtonsDisabled(true);
                setTimeout(() => {
                    setAllButtonsDisabled(false);
                }, cooldown * 1000);
                throw new Error(`Rate Limit: ${data.error}, cooldown ${cooldown}`);
            }

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const msg = data.error || (`HTTP Error ${response.status}`);
                alert(msg);
                throw new Error(`HTTP ${response.status} - ${msg}`);
            }

            return response.json();
        }

        // Simple sanitizer for the API key
        function sanitizeApiKey(key) {
            return key.replace(/[^a-zA-Z0-9-_]/g, '');
        }

        // For demonstration, treat any key >= length 10 as "valid"
        function isApiKeyValid(key) {
            if (!key) return false;
            return key.length >= 10;
        }

        // We store the setInterval ID here so we can clear it if key is invalid
        let statusInterval = null;

        function checkApiKeyState() {
            const apiKeyElem = document.getElementById('apiKey');
            const rawKey = apiKeyElem.value;
            const sanitizedKey = sanitizeApiKey(rawKey);
            if (rawKey !== sanitizedKey) {
                apiKeyElem.value = sanitizedKey;
            }

            const valid = isApiKeyValid(sanitizedKey);
            const apiKeyStateElem = document.getElementById('apiKeyState');

            if (valid) {
                apiKeyStateElem.textContent = "API Key State: Valid";
                document.getElementById('refreshChart').style.display = 'inline-block';
                document.getElementById('startScan').style.display = 'inline-block';
                document.querySelector('#paramsForm button[type="submit"]').style.display = 'inline-block';

                // Start auto-refresh of status every second if not running
                if (!statusInterval) {
                    statusInterval = setInterval(() => {
                        refreshStatus().catch(err => console.log(err));
                    }, 1000);
                }
            } else {
                apiKeyStateElem.textContent = "API Key State: Invalid";
                document.getElementById('refreshChart').style.display = 'inline-block';
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display = 'none';
                document.querySelector('#paramsForm button[type="submit"]').style.display = 'none';

                // Stop auto-refresh if the key is invalid
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            }
        }

        async function checkCSVStatus() {
            try {
                const data = await doFetch('/api/csv_status');
                const refreshBtn = document.getElementById('refreshChart');
                if (!data.exists || data.empty) {
                    refreshBtn.disabled = true;
                } else {
                    refreshBtn.disabled = false;
                }
            } catch (err) {
                console.log("Error checking CSV status:", err);
            }
        }

        // Plugin to display total players in top-right corner
        const totalPlayerPlugin = {
            id: 'totalPlayerPlugin',
            afterDraw: (chart) => {
                const {ctx, chartArea: {top, right}} = chart;
                ctx.save();
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'right';
                const totalPlayers = chart.config.data.totalPlayers || 0;
                ctx.fillText('Total Players: ' + totalPlayers, right - 10, top + 20);
                ctx.restore();
            }
        };

        async function fetchData() {
            return doFetch('/api/data');
        }

        function renderChart(data) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            const chartData = {
                labels: data.labels,
                datasets: data.datasets,
                totalPlayers: data.totalPlayers 
            };

            if (window.myChart instanceof Chart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Top ${data.shownMapsCount} Maps out of ${data.totalFilteredMaps}`,
                            color: 'white'
                        },
                        legend: {
                            labels: { color: 'white' }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        }
                    }
                },
                plugins: [totalPlayerPlugin]
            });

            document.getElementById('playerCountDisplay').textContent = 
                "Average Daily Player Count: " + data.averageDailyPlayerCount;
        }

        // Throttle chart refresh to avoid spam
        const updateChart = createThrottledFunction(async function() {
            await checkCSVStatus();
            const data = await fetchData();
            if (!data.labels || data.labels.length === 0) {
                alert("No chart data found (CSV empty or out of range).");
                return;
            }
            renderChart(data);
        }, 3000);

        async function startScanning() {
            const result = await doFetch('/api/start_scan', { 
                method: 'POST'
            });
            alert(result.status || result.error);
        }

        async function stopScanning() {
            const result = await doFetch('/api/stop_scan', { 
                method: 'POST'
            });
            alert(result.status || result.error);
        }

        async function updateParameters(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('paramsForm'));
            const params = {};
            formData.forEach((value, key) => {
                if (key === 'apiKey') return; // skip the raw key field
                params[key] = value;
            });

            const result = await doFetch('/api/update_params', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            alert(result.status || result.error);
        }

        async function fetchStatus() {
            return doFetch('/api/status');
        }

        async function refreshStatus() {
            const statusData = await fetchStatus();
            document.getElementById('scanningStatus').textContent = 
                "Scanning Status: " + statusData.scanning_status;
            document.getElementById('scanningMode').textContent = 
                "Scanning Mode: " + statusData.scanning_mode;
            document.getElementById('currentIP').textContent = 
                "Current IP: " + (statusData.current_scanned_ip || "None");
            document.getElementById('lastError').textContent = 
                "Last Error: " + (statusData.last_error || "None");

            // Also re-check API Key state for possibly updated input
            checkApiKeyState();

            // Show/hide start/stop buttons depending on scanning status
            const valid = isApiKeyValid(document.getElementById('apiKey').value);
            if (valid) {
                if (statusData.scanning_status === "Scanning") {
                    document.getElementById('startScan').style.display = "none";
                    document.getElementById('stopScan').style.display = "inline-block";
                } else {
                    document.getElementById('startScan').style.display = "inline-block";
                    document.getElementById('stopScan').style.display = "none";
                }
            } else {
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            checkApiKeyState();
            await checkCSVStatus();
            await refreshStatus();
        });

        document.getElementById('startScan').addEventListener('click', startScanning);
        document.getElementById('stopScan').addEventListener('click', stopScanning);
        document.getElementById('paramsForm').addEventListener('submit', updateParameters);
        document.getElementById('refreshChart').addEventListener('click', updateChart);
        document.getElementById('refreshStatus').addEventListener('click', refreshStatus);
    </script>
</body>
</html>
