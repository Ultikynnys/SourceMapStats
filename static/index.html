<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Map Stats Visualization</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- =========================================================
         GitHub CORNER (fixed notch, top‑right)
         ========================================================= -->
    <a href="https://github.com/Ultikynnys/SourceMapStats"
       class="github-corner"
       aria-label="View SourceMapStats on GitHub"
       target="_blank" rel="noopener">
        <svg width="100" height="100" viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"
                  fill="#f39c12"></path>
            <path class="octo-arm"
                  d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6
                     C122.0,82.7 120.5,78.6 120.5,78.6
                     C119.2,72.0 123.4,76.3 123.4,76.3
                     C127.3,80.9 125.5,87.3 125.5,87.3
                     C122.9,97.6 130.6,101.9 134.4,103.2"
                  fill="currentColor"
                  style="transform-origin: 130px 106px;"></path>
            <path class="octo-body"
                  d="M115.0,115.0
                     C114.9,115.1 118.7,116.5 119.8,115.4
                     L133.7,101.6
                     C136.9,99.2 139.9,98.4 142.2,98.6
                     C133.8,88.0 127.5,74.4 143.8,58.0
                     C148.5,53.4 154.0,51.2 159.7,51.0
                     C160.3,49.4 163.2,43.6 171.4,40.1
                     C171.4,40.1 176.1,42.5 178.8,56.2
                     C183.1,58.6 187.2,61.8 190.9,65.4
                     C194.5,69.0 197.7,73.2 200.1,77.6
                     C213.8,80.2 216.3,84.9 216.3,84.9
                     C212.7,93.1 206.9,96.0 205.4,96.6
                     C205.1,102.4 203.0,107.8 198.3,112.5
                     C181.9,128.9 168.3,122.5 157.7,114.1
                     C157.9,116.9 156.7,120.9 152.7,124.9
                     L141.0,136.5
                     C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                  fill="currentColor"></path>
        </svg>
    </a>

    <!-- =========================================================
         MAIN APP
         ========================================================= -->
    <div class="container">
        <header>
            <h1>Map Stats Visualization</h1>
        </header>

        <div class="chart-params-container">
            <!-- LEFT: chart + status -->
            <div class="left-column">
                <section class="chart-box">
                    <canvas id="chartCanvas" width="800" height="400"></canvas>
                    <p id="playerCountDisplay"></p>
                    <button id="refreshChart" class="btn">Refresh Chart</button>
                </section>

                <section class="status-section">
                    <h2>Status</h2>
                    <div class="btn-group">
                        <button id="startScan" class="btn">Start Scanning</button>
                        <button id="stopScan"  class="btn">Stop Scanning</button>
                    </div>
                    <p id="scanningStatus">Scanning Status: Idle</p>
                    <p id="scanningMode">Scanning Mode: None</p>
                    <p id="currentIP">Current IP: None</p>
                    <p id="lastError">Last Error: None</p>
                    <p id="apiKeyState">API Key State: Unknown</p>

                    <!-- NEW: connection indicator (populated by JS) -->
                    <p id="connectionStatus" class="disconnected">No server found</p>

                    <button id="refreshStatus" class="btn">Refresh Status</button>
                </section>
            </div>

            <!-- RIGHT: parameters -->
            <section class="params-section">
                <h2>Parameters</h2>
                <form id="paramsForm">
                    <!-- (unchanged form) -->
                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="text" id="apiKey" name="apiKey" value="">
                    </div>
                    <div class="form-group">
                        <label for="MapsToShow">Maps To Show:</label>
                        <input type="number" id="MapsToShow" name="MapsToShow" value="15">
                    </div>
                    <div class="form-group">
                        <label for="Start_Date">Start Date:</label>
                        <input type="date" id="Start_Date" name="Start_Date" value="2001-10-02">
                    </div>
                    <div class="form-group">
                        <label for="End_Date">End Date:</label>
                        <input type="date" id="End_Date" name="End_Date" value="2040-10-02">
                    </div>
                    <div class="form-group">
                        <label for="OnlyMapsContaining">Only Maps Containing:</label>
                        <input type="text" id="OnlyMapsContaining" name="OnlyMapsContaining" value="dr_">
                    </div>
                    <div class="form-group">
                        <label for="AverageDays">Average Days:</label>
                        <input type="number" id="AverageDays" name="AverageDays" value="1">
                    </div>
                    <div class="form-group">
                        <label for="FastWriteDelay">Fast Write Delay&nbsp;(min):</label>
                        <input type="number" id="FastWriteDelay" name="FastWriteDelay" value="10">
                    </div>
                    <div class="form-group">
                        <label for="RuntimeMinutes">Runtime Minutes:</label>
                        <input type="number" id="RuntimeMinutes" name="RuntimeMinutes" value="60">
                    </div>
                    <div class="form-group">
                        <label for="ColorIntensity">Color Intensity:</label>
                        <input type="number" id="ColorIntensity" name="ColorIntensity" value="3">
                    </div>
                    <div class="form-group">
                        <label for="Game">Game:</label>
                        <input type="text" id="Game" name="Game" value="tf">
                    </div>
                </form>
            </section>
        </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <footer>
        <div class="footer-content">
            <p class="description">
                <strong>SourceMapStats</strong> is a Source&nbsp;Master&nbsp;Server map‑statistics tool.
                It gathers player frequency for every map in a selected game, then filters that data
                into a visualization chart so you can instantly see player counts per map and game‑mode.
            </p>
            <p class="copyright">&copy; Ultikynnys 2025</p>
        </div>
    </footer>

    <!-- ================= JS ================= -->
    <script>
        /*  -----------------  HELPER  ----------------- */
        function createThrottledFunction(fn, delay) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }
        function setAllButtonsDisabled(disabled) {
            document.querySelectorAll("button").forEach(btn => btn.disabled = disabled);
        }
        async function doFetch(url, options = {}) {
            options.headers = options.headers || {};
            const rawKey       = document.getElementById('apiKey')?.value || '';
            const sanitizedKey = rawKey.replace(/[^a-zA-Z0-9-_]/g, '');

            if (sanitizedKey.length >= 10) options.headers['X-API-KEY'] = sanitizedKey;

            const response = await fetch(url, options);

            /* Rate‑limit handling */
            if (response.status === 429) {
                const data      = await response.json().catch(() => ({}));
                const cooldown  = 1;        /* seconds */
                alert(`Rate Limited: ${data.error || 'Too many requests'}. Cool‑down: ${cooldown}s`);
                setAllButtonsDisabled(true);
                setTimeout(() => setAllButtonsDisabled(false), cooldown * 1000);
                throw new Error('Rate Limit');
            }

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const msg  = data.error || `HTTP Error ${response.status}`;
                alert(msg);
                throw new Error(msg);
            }
            return response.json();
        }
        function sanitizeApiKey(key)  { return key.replace(/[^a-zA-Z0-9-_]/g, ''); }
        function isApiKeyValid(key)   { return key && key.length >= 10; }

        /*  -----------------  CONNECTION STATUS  ----------------- */
        async function updateConnectionStatus () {
            const el = document.getElementById('connectionStatus');
            try {
                const res = await fetch('/api/heartbeat', { cache: 'no-store' });
                if (res.ok) {
                    el.textContent = 'Connected';
                    el.classList.remove('disconnected');
                    el.classList.add('connected');
                } else {
                    throw new Error('Heartbeat failed');
                }
            } catch (_) {
                el.textContent = 'No server found';
                el.classList.remove('connected');
                el.classList.add('disconnected');
            }
        }
        /* ping immediately, then every 5 s */
        setInterval(updateConnectionStatus, 5_000);

        /*  -----------------  STATUS  ----------------- */
        let statusInterval = null;
        function checkApiKeyState() {
            const apiKeyElem  = document.getElementById('apiKey');
            const sanitized   = sanitizeApiKey(apiKeyElem.value);
            if (apiKeyElem.value !== sanitized) apiKeyElem.value = sanitized;

            const valid = isApiKeyValid(sanitized);
            document.getElementById('apiKeyState').textContent =
                `API Key State: ${valid ? 'Valid' : 'Invalid'}`;
            document.getElementById('refreshChart').style.display = 'inline-block';
            document.getElementById('startScan').style.display    = valid ? 'inline-block' : 'none';
            document.getElementById('stopScan').style.display     = valid ? 'inline-block' : 'none';

            if (valid && !statusInterval) {
                statusInterval = setInterval(() => refreshStatus().catch(console.error), 1_000);
            } else if (!valid && statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }
        async function checkCSVStatus() {
            try {
                const data = await doFetch('/api/csv_status');
                document.getElementById('refreshChart').disabled = !(data.exists && !data.empty);
            } catch (e) { console.error(e); }
        }

        /*  -----------------  CHART  ----------------- */
        const totalPlayerPlugin = {
            id: 'totalPlayerPlugin',
            afterDraw: chart => {
                const { ctx, chartArea:{ top, right } } = chart;
                ctx.save();
                ctx.fillStyle   = 'white';
                ctx.font        = '16px Arial';
                ctx.textAlign   = 'right';
                ctx.fillText(`Total Players: ${chart.config.data.totalPlayers || 0}`, right - 10, top + 20);
                ctx.restore();
            }
        };
        async function fetchData() { return doFetch('/api/data'); }

        function renderChart(data) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            const chartData = { labels: data.labels, datasets: data.datasets, totalPlayers: data.totalPlayers };

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: false,
                    plugins: {
                        title:   { display: true, text: `Top ${data.shownMapsCount} Maps out of ${data.totalFilteredMaps}`, color: 'white' },
                        legend:  { labels: { color: 'white' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.2)' } },
                        y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.2)' } }
                    }
                },
                plugins: [ totalPlayerPlugin ]
            });
            document.getElementById('playerCountDisplay').textContent =
                `Average Daily Player Count: ${data.averageDailyPlayerCount}`;
        }

        const updateChart = createThrottledFunction(async () => {
            /* Push current form values to API */
            const formData = new FormData(document.getElementById('paramsForm'));
            const params   = {};
            formData.forEach((value, key) => { if (key !== 'apiKey') params[key] = value; });

            await doFetch('/api/update_params', {
                method:  'POST',
                headers: { 'Content-Type': 'application/json' },
                body:    JSON.stringify(params)
            });

            await checkCSVStatus();
            const data = await fetchData();
            if (!data.labels?.length) { alert('No chart data found (CSV empty or out of range).'); return; }
            renderChart(data);
        }, 1_000);

        /*  -----------------  SCAN / STATUS BUTTONS  ----------------- */
        async function startScanning()  { const res = await doFetch('/api/start_scan', { method:'POST' }); alert(res.status || res.error); }
        async function stopScanning()   { const res = await doFetch('/api/stop_scan',  { method:'POST' }); alert(res.status || res.error); }
        async function fetchStatus()    { return doFetch('/api/status'); }
        async function refreshStatus() {
            const s = await fetchStatus();
            document.getElementById('scanningStatus').textContent = `Scanning Status: ${s.scanning_status}`;
            document.getElementById('scanningMode').textContent   = `Scanning Mode: ${s.scanning_mode}`;
            document.getElementById('currentIP').textContent      = `Current IP: ${s.current_scanned_ip || 'None'}`;
            document.getElementById('lastError').textContent      = `Last Error: ${s.last_error || 'None'}`;
            checkApiKeyState();
        }

        /*  -----------------  INIT  ----------------- */
        document.addEventListener('DOMContentLoaded', async () => {
            updateConnectionStatus();   /* first ping   */
            checkApiKeyState();
            await checkCSVStatus();
            await refreshStatus();
        });
        document.getElementById('refreshChart').addEventListener('click', updateChart);
        document.getElementById('startScan').addEventListener('click',   startScanning);
        document.getElementById('stopScan').addEventListener('click',    stopScanning);
        document.getElementById('refreshStatus').addEventListener('click', refreshStatus);
    </script>
</body>
</html>
