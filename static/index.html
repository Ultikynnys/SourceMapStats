<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Map Stats Visualization</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Octocat loader -->
    <script src="/static/octocat-loader.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>Map Stats Visualization</h1>
        </header>

        <div class="chart-params-container">
            <!-- LEFT: ranking -->
            <section class="ranking-section">
                <h2>Ranking</h2>
                <ol id="mapRanking"></ol>
            </section>

            <!-- MIDDLE: chart + status -->
            <div class="chart-status-section">
                <section class="chart-box">
                    <canvas id="chartCanvas" width="800" height="400"></canvas>
                    <p id="playerCountDisplay"></p>
                    <button id="refreshChart" class="btn">Refresh Chart</button>
                </section>

                <section class="status-section">
                    <h2>Status</h2>
                    <div class="btn-group">
                        <button id="startScan" class="btn">Start Scanning</button>
                        <button id="stopScan"  class="btn">Stop Scanning</button>
                    </div>
                    <p id="scanningStatus">Scanning Status: Idle</p>
                    <p id="scanningMode">Scanning Mode: None</p>
                    <p id="cooldownRemaining">Cooldown Remaining: — s</p>
                    <p id="currentIP">Current IP: None</p>
                    <p id="lastError">Last Error: None</p>
                    <p id="requestsLeft">Requests Left: —</p>
                    <p id="ratelimitReset">Rate-limit Reset In: — s</p>
                    <p id="ipTimeout">IP-Scan Timeout: — s</p>
                    <p id="apiKeyState">API Key State: Unknown</p>
                    <p id="connectionStatus" class="disconnected">No server found</p>
                    <button id="refreshStatus" class="btn">Refresh Status</button>
                </section>
            </div>

            <!-- RIGHT: parameters -->
            <section class="params-section">
                <h2>Parameters</h2>
                <form id="paramsForm">
                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="text" id="apiKey" name="apiKey" value="">
                    </div>
                    <div class="form-group">
                        <label for="MapsToShow">Maps To Show:</label>
                        <select id="MapsToShow" name="MapsToShow">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10" selected>10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Start_Date">Start Date:</label>
                        <input type="date" id="Start_Date" name="Start_Date" value="2001-10-02">
                    </div>
                    <div class="form-group">
                        <label for="End_Date">End Date:</label>
                        <input type="date" id="End_Date" name="End_Date" value="2040-10-02">
                    </div>
                    <div class="form-group">
                        <label for="OnlyMapsContaining">Only Maps Containing:</label>
                        <input type="text" id="OnlyMapsContaining" name="OnlyMapsContaining" value="dr_">
                    </div>
                    <div class="form-group">
                        <label for="AverageDays">Days Per Point:</label>
                        <select id="AverageDays" name="AverageDays">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="7">7</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                    <div class="form-group" id="fastWriteGroup">
                        <label for="FastWriteDelay">Fast Write Delay (min):</label>
                        <input type="number" id="FastWriteDelay" name="FastWriteDelay" value="10">
                    </div>
                    <div class="form-group" id="runtimeMinutesGroup">
                        <label for="RuntimeMinutes">Runtime Minutes:</label>
                        <input type="number" id="RuntimeMinutes" name="RuntimeMinutes" value="60">
                    </div>
                    <div class="form-group">
                        <label for="ColorIntensity">Color Intensity:</label>
                        <input type="number" id="ColorIntensity" name="ColorIntensity" value="3">
                    </div>
                    <div class="form-group">
                        <label for="Game">Game:</label>
                        <select id="Game" name="Game">
                            <option value="tf" selected>Team Fortress 2 (tf)</option>
                            <option value="csgo">Counter-Strike: Global Offensive (csgo)</option>
                            <option value="cstrike">Counter-Strike: Source (cstrike)</option>
                            <option value="dod">Day of Defeat: Source (dod)</option>
                            <option value="hl2mp">Half-Life 2: Deathmatch (hl2mp)</option>
                            <option value="left4dead2">Left 4 Dead 2 (left4dead2)</option>
                            <option value="left4dead">Left 4 Dead (left4dead)</option>
                            <option value="garrysmod">Garry’s Mod (garrysmod)</option>
                            <option value="insurgency">Insurgency (insurgency)</option>
                            <option value="synergy">Synergy (synergy)</option>
                            <option value="alienswarm">Alien Swarm (alienswarm)</option>
                        </select>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p class="description">
                <strong>SourceMapStats</strong> is a map-statistics tool that queries the Source Master Server,
                gathers player frequency per map, and renders that data as an interactive chart.
            </p>
            <p class="copyright">&copy; Ultikynnys 2025</p>
        </div>
    </footer>

    <script>
        /* Helpers & throttling */
        function createThrottledFunction(fn, delay) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }
        function setAllButtonsDisabled(disabled) {
            document.querySelectorAll("button").forEach(btn => btn.disabled = disabled);
        }

        /* Sanitizers & rules */
        function sanitizeApiKey(key) { return key.replace(/[^a-zA-Z0-9-_]/g, ''); }
        function hasValidApiKey(key) { return key && key.length >= 10; }

        /* Fetch wrapper */
        async function doFetch(url, options = {}) {
            options.headers = options.headers || {};
            const rawKey = document.getElementById('apiKey')?.value || '';
            const key = sanitizeApiKey(rawKey);
            if (hasValidApiKey(key)) options.headers['X-API-KEY'] = key;
            const response = await fetch(url, options);
            if (response.status === 429) {
                const data = await response.json().catch(() => ({}));
                const cooldown = 1;
                alert(`Rate Limited: ${data.error || 'Too many requests'}. Cool-down: ${cooldown}s`);
                setAllButtonsDisabled(true);
                setTimeout(() => setAllButtonsDisabled(false), cooldown * 1000);
                throw new Error('Rate Limit');
            }
            if (response.status === 401) {
                document.getElementById('apiKeyState').textContent = 'API Key State: Invalid';
                throw new Error('Unauthorized');
            }
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const msg = data.error || `HTTP Error ${response.status}`;
                alert(msg);
                throw new Error(msg);
            }
            return response.json();
        }

        /* Key validation & status */
        let statusInterval = null;
        async function validateApiKey(key) {
            if (!hasValidApiKey(key)) return false;
            try {
                const res = await fetch('/api/validate_key', {
                    cache: 'no-store',
                    headers: { 'X-API-KEY': key }
                });
                return res.ok;
            } catch {
                return false;
            }
        }
        function toggleExtraParams(show) {
            document.getElementById('fastWriteGroup').style.display = show ? 'flex' : 'none';
            document.getElementById('runtimeMinutesGroup').style.display = show ? 'flex' : 'none';
        }
        async function checkApiKeyState() {
            const elem = document.getElementById('apiKey');
            const raw = elem.value;
            const key = sanitizeApiKey(raw);
            if (raw !== key) elem.value = key;
            if (!hasValidApiKey(key)) {
                document.getElementById('apiKeyState').textContent = 'API Key State: Not supplied — chart-only mode';
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display = 'none';
                toggleExtraParams(false);
                if (statusInterval) { clearInterval(statusInterval); statusInterval = null; }
                return;
            }
            const valid = await validateApiKey(key);
            if (!valid) {
                document.getElementById('apiKeyState').textContent = 'API Key State: Invalid';
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display = 'none';
                toggleExtraParams(false);
                if (statusInterval) { clearInterval(statusInterval); statusInterval = null; }
                return;
            }
            document.getElementById('apiKeyState').textContent = 'API Key State: Valid';
            document.getElementById('startScan').style.display = 'inline-block';
            document.getElementById('stopScan').style.display = 'inline-block';
            toggleExtraParams(true);
            if (!statusInterval) {
                statusInterval = setInterval(() => refreshStatus().catch(console.error), 1000);
            }
        }

        /* Connection heartbeat */
        async function updateConnectionStatus() {
            const el = document.getElementById('connectionStatus');
            try {
                const data = await fetch('/api/heartbeat', { cache: 'no-store' })
                    .then(res => { if (!res.ok) throw ''; return res.json(); });
                el.textContent = 'Connected';
                el.classList.remove('disconnected');
                el.classList.add('connected');
                document.getElementById('requestsLeft').textContent =
                    `Requests Left: ${data.requests_left}`;
                document.getElementById('ratelimitReset').textContent =
                    `Rate-limit Reset In: ${data.ratelimit_reset}s`;
            } catch {
                el.textContent = 'No server found';
                el.classList.remove('connected');
                el.classList.add('disconnected');
            }
        }
        setInterval(updateConnectionStatus, 5000);

        /* CSV status */
        async function checkCSVStatus() {
            try {
                const data = await doFetch('/api/csv_status');
                document.getElementById('refreshChart').disabled = !(data.exists && !data.empty);
            } catch {}
        }

        /* Scan controls */
        async function startScanning() {
            const key = sanitizeApiKey(document.getElementById('apiKey').value);
            if (!hasValidApiKey(key)) { alert('API key must be at least 10 characters.'); return; }
            try {
                const res = await doFetch('/api/start_scan', { method:'POST' });
                alert(res.status || res.error);
            } catch {}
        }
        async function stopScanning() {
            const key = sanitizeApiKey(document.getElementById('apiKey').value);
            if (!hasValidApiKey(key)) { alert('API key must be at least 10 characters.'); return; }
            try {
                const res = await doFetch('/api/stop_scan', { method:'POST' });
                alert(res.status || res.error);
            } catch {}
        }

        /* Status refresh */
        async function refreshStatus() {
            try {
                const s = await doFetch('/api/status');
                document.getElementById('scanningStatus').textContent =
                  `Scanning Status: ${s.scanning_status}`;
                document.getElementById('scanningMode').textContent =
                  `Scanning Mode: ${s.scanning_mode}`;
                document.getElementById('currentIP').textContent =
                  `Current IP: ${s.current_scanned_ip || 'None'}`;
                document.getElementById('lastError').textContent =
                  `Last Error: ${s.last_error || 'None'}`;
                document.getElementById('cooldownRemaining').textContent =
                  `Cooldown Remaining: ${s.cooldown_remaining}s`;
                document.getElementById('ipTimeout').textContent =
                  `IP-Scan Timeout: ${s.ip_scan_timeout}s`;
            } catch {}
        }

        /* Chart + ranking */
        async function fetchData() { return doFetch('/api/data'); }

        function renderChart(data) {
  // 1. Compute per‐map averages (excluding "Other Maps")
  const mapDatasets = data.datasets.filter(ds => ds.label !== 'Other Maps');
  const mapAverages = mapDatasets.map(ds => {
    const sum = ds.data.reduce((a, b) => a + b, 0);
    return { label: ds.label, avg: sum / ds.data.length };
  });
  // 2. Sort descending by average
  mapAverages.sort((a, b) => b.avg - a.avg);

  // 3. Total of all averages for percent calculation
  const totalAvg = mapAverages.reduce((sum, m) => sum + m.avg, 0);

  // 4. Build the ranking list HTML with medals & percentages
  document.getElementById('mapRanking').innerHTML = mapAverages
    .map((m, i) => {
      const pct = (m.avg / totalAvg) * 100;
      let medal = '';
      if (i === 0)      medal = '🥇 ';
      else if (i === 1) medal = '🥈 ';
      else if (i === 2) medal = '🥉 ';
      return `<li>
                ${medal}${m.label}
                <span class="rank-pct">(${pct.toFixed(1)}%)</span>
              </li>`;
    })
    .join('');

  // 5. Prepare raw totals & chart datasets
  const rawTotals = data.datasets[0].data.map((_, idx) =>
    data.datasets.reduce((sum, ds) => sum + ds.data[idx], 0)
  );
  const avgDailyCount = rawTotals.reduce((s, v) => s + v, 0) / rawTotals.length;
  const percentDatasets = data.datasets.map(ds => ({
    label: ds.label,
    data: ds.data.map((count, idx) =>
      rawTotals[idx] ? (count / rawTotals[idx]) * 100 : 0
    ),
    borderColor: ds.borderColor,
    backgroundColor: ds.backgroundColor,
    fill: ds.fill
  }));

  // 6. Render Chart.js line chart
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: percentDatasets
    },
    options: {
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: `Top ${data.shownMapsCount} Maps as % of Shown Total`,
          color: 'white'
        },
        legend: { labels: { color: 'white' } },
        tooltip: {
          mode: 'index',
          intersect: false,
          itemSort: (a, b) => {
            const oa = a.dataset.label === 'Other Maps';
            const ob = b.dataset.label === 'Other Maps';
            if (oa && !ob) return 1;
            if (!oa && ob) return -1;
            return b.parsed.y - a.parsed.y;
          },
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: 'white' },
          grid: { color: 'rgba(255,255,255,0.2)' }
        },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: { color: 'white', callback: v => v + '%' },
          grid: { color: 'rgba(255,255,255,0.2)' }
        }
      }
    }
  });

  // 7. Update average player‐count text
  document.getElementById('playerCountDisplay').textContent =
    `Average player count for maps containing "${document.getElementById('OnlyMapsContaining').value}": ${avgDailyCount.toFixed(1)}`;
}

        const updateChart = createThrottledFunction(async()=>{
            const formData = new FormData(document.getElementById('paramsForm'));
            const params = {};
            formData.forEach((v,k)=>{ if(k!=='apiKey') params[k]=v; });
            await doFetch('/api/update_params',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(params)
            });
            await checkCSVStatus();
            const data = await fetchData();
            if(!data.labels?.length){ alert('No chart data found (CSV empty or out of range).'); return; }
            renderChart(data);
        },1000);

        /* Init & listeners */
        document.addEventListener('DOMContentLoaded',async()=>{
            updateConnectionStatus();
            await checkApiKeyState();
            await checkCSVStatus();
            await refreshStatus();
            updateChart();
        });
        document.getElementById('refreshChart').addEventListener('click',updateChart);
        document.getElementById('startScan').addEventListener('click',startScanning);
        document.getElementById('stopScan').addEventListener('click',stopScanning);
        document.getElementById('refreshStatus').addEventListener('click',refreshStatus);
        document.getElementById('apiKey').addEventListener('input',()=>checkApiKeyState().catch(console.error));
    </script>
</body>
</html>
